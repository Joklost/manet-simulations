\section{Hardware Emulation}\label{sec:mpiprotocol}
In this section, we will introduce the hardware functions required to emulate the radio hardware on a wireless sensor node. The three essential functions for hardware emulation is: broadcasting (\autoref{algo:hwfuncstransmit}), listening (\autoref{algo:hwfuncslisten}), and sleeping (\autoref{algo:hwfuncssleep}). Additionally, a function for reporting the current local time (\autoref{algo:hwfuncsupdatelocaltime}) to the controller is added. This function should be used whenever none of the above functions are applicable, and will allow the controller to continue processing requests from other nodes.

%as well as a sample protocol that we can implement, using these functions. 

%\autoref{sec:saloha} will present the Slotted ALOHA protocol, and \autoref{sec:hwfuncspseudo} will present the three functions, along with pseudocode descriptions of these.

%\subsection{Hardware Functions}\label{sec:hwfuncspseudo}


\begin{algorithm}[ht]
    \DontPrintSemicolon
    \SetAlgorithmName{Data Structure}{Data Structure}

    \textbf{Structure} Message \{ action, source, localtime, duration, data \}\;
    \;
    clock $\leftarrow$ \Now\;
    localtime $\leftarrow$ 0\;
    id $\leftarrow$ unique identifier\;
 
    \caption{The shared variables and structures used by the hardware functions.}
    \label{algo:protocolsharedstate}
\end{algorithm}

\todo[inline]{fix autoref for data structure}
\todo[inline]{fix ref for virtual time}

The shared state for the hardware functions consist of three variables (\autoref{algo:protocolsharedstate}): \texttt{clock}, \texttt{localtime}, and \texttt{id}. The \texttt{clock} variable is used to measure the real-time spent by the node, between calls to the hardware function. \texttt{localtime} is used to track the local time of the node, as well as to enable virtual time (introduced in \autoref{sec:virtualtime}). Finally the \texttt{id} variable is a unique identifier assigned to each particular node. A common element for all of the hardware functions is that we initially update the \texttt{localtime} variable with the elapsed time since the \texttt{clock} variable was reset last, before transmitting the current local time, as well as a duration, to the controller. The \texttt{clock} variable is reset at the end of all of the functions, after an acknowledgement has been received from the controller.\medbreak

\begin{algorithm}[ht]
    \DontPrintSemicolon
    \KwResult{The time it took to broadcast the packet}
    \SetKwFunction{FBroadcast}{Broadcast}
    \SetKwProg{Fn}{Function}{}{}
    
    \Fn{\FBroadcast{packet}}{
        localtime $\leftarrow$ (\Now $-$ clock) $+$ localtime\;
        duration $\leftarrow$ transmission\_time(|packet|)\;
        m $\leftarrow$ \{ transmit, id, localtime, duration, packet \}\;
        \Send m \KwTo controller\;
        localtime $\leftarrow$ \Await ack \From controller\;
        clock $\leftarrow$ \Now\;
        \KwRet duration\;
    }

    \caption{The Broadcast Function.}
    \label{algo:hwfuncstransmit}
\end{algorithm}

The \texttt{Broadcast} (\autoref{algo:hwfuncstransmit}) function takes any arbitrary data packet, sends this to the controller using the \gls{mpi}, and waits for an acknowledgement from the controller. The controller takes care of distributing the packet to neighbouring nodes, including computing the probability of the neighbouring node receiving the packet. The duration required for transmitting a packet is computed using the baudrate, as specified by the hardware parameters described in \autoref{sed:baudrate}. This is sent to the controller, along with the packet, and we wait for an acknowledgement from the controller, containing our new local time.\medbreak
\todo[inline]{fix ref for baudrate}

\begin{algorithm}[ht]
    \DontPrintSemicolon
    \KwResult{list of packets}
    \SetKwFunction{FListen}{Listen}
    \SetKwProg{Fn}{Function}{}{}
    
    \Fn{\FListen{duration}}{
        localtime $\leftarrow$ (\Now $-$ clock) $+$ localtime\;
        m $\leftarrow$ \{ listen, id, localtime, duration \}\;
        \Send m \KwTo controller\;

        packets $\leftarrow$ empty list\;
        c $\leftarrow$ \Await count \From controller\;
        \For{i $\leftarrow$ 0 \KwTo c}{
            p $\leftarrow$ \Await packet \From controller\;
            \Append p \KwTo packets\;
        }

        localtime $\leftarrow$ \Await ack \From controller\;
        clock $\leftarrow$ \Now\;
        \KwRet packets\;
    }
    
    \caption{The Listen Function.}
    \label{algo:hwfuncslisten}
\end{algorithm}

The \texttt{Listen} (\autoref{algo:hwfuncslisten}) function takes a duration, and sends this, along with the updated local time, to the controller. The controller will return any packets the listening node have received within the duration, as well as an acknowledgement containing the new local time of the node.\medbreak

\begin{algorithm}[ht]
    \DontPrintSemicolon
    \SetKwFunction{FSleep}{Sleep}
    \SetKwProg{Fn}{Function}{}{}
    
    \Fn{\FSleep{duration}}{
        localtime $\leftarrow$ (\Now $-$ clock) $+$ localtime\;
        m $\leftarrow$ \{ sleep, id, localtime, duration \}\;
        \Send m \KwTo controller\;
        localtime $\leftarrow$ \Await ack \From controller\;
        clock $\leftarrow$ \Now\;
    }
    
    \caption{The Sleep Function.}
    \label{algo:hwfuncssleep}
\end{algorithm}

The \texttt{Sleep} (\autoref{algo:hwfuncssleep}) function also takes an duration, and sends this, along with the updated local time to the controller. The controller will send an acknowledgement containing the new local time of the node.\medbreak

\begin{algorithm}[ht]
    \DontPrintSemicolon
    \SetKwFunction{FReportLocalTime}{ReportLocalTime}
    \SetKwProg{Fn}{Function}{}{}
    
    \Fn{\FReportLocalTime{}}{
        localtime $\leftarrow$ (\Now $-$ clock) $+$ localtime\;
        m $\leftarrow$ \{ report-localtime, id, localtime \}\;
        \Send m \KwTo controller\;
        clock $\leftarrow$ \Now\;
    }
    
    \caption{The ReportLocaltime Function.}
    \label{algo:hwfuncsupdatelocaltime}
\end{algorithm}

Finally, the \texttt{ReportLocalTime} (\autoref{algo:hwfuncsupdatelocaltime}) function is included in the case where none of the above hardware functions are applicable. The function will send a message to the controller with the updated local time, and reset the \texttt{clock} variable.