
\begin{algorithm}[H]
    \DontPrintSemicolon
    \SetKwFunction{FCoordinator}{Coordinator}
    \SetKwProg{Fn}{procedure}{}{}

    % \tcp{Tuples are accessed by dot notation}
    Action = (type, source, start, end, packet)\;
    \;

    \Fn{\FCoordinator{}}{
        waiting $\leftarrow$ priority queue of Action objects, ordered by end, transmit before listen\;
        transmissions $\leftarrow$ empty list of Action objects\;
        \;
        
        \Repeat{\textit{protocol terminates}}{
            m $\leftarrow$ \KwAwait Action \KwFrom any node\; \label{line:action-await}
            \KwEnqueue m \KwTo waiting\;
            \If{m.type = transmit}{ \label{line:message-transmit}
                \KwAppend m \KwTo transmissions\;
            }
            % \tcp{sleep and inform actions are implicitly handled}
            \;
            \While{each node has at least one Action in waiting}{
                a $\leftarrow$ \KwDequeue Action \KwFrom waiting\;

                \If{a.type = transmit}{ \label{line:action-transmit}
                    interferers $\leftarrow$ empty list of node identifiers\;
                    \ForEach{t $\in$ transmissions \KwWhere t $\neq$ a}{
                        \If{a.end $\leq$ t.start \KwAnd a.start $\geq$ t.end}{
                            \tcp{Transmissions intersect}
                            \KwAppend t.source \KwTo interferers\;
                        }
                    }

                    \ForEach{l $\in$ waiting \KwWhere l.type = listen}{
                        \If{a.start $\geq$ l.start \KwAnd a.end $\leq$ l.end}{
                            probability $\leftarrow$ $P_p$(l.source, a.source, interferers, |a.packet|)\;
                            should-receive $\leftarrow$ randomly choose based on probability\;
                            \If{should-receive}{
                                l.end = a.end\;
                                l.packet = a.packet\;
                            }
                        }
                    }
                }

                \ElseIf{a.type = listen}{ \label{line:action-listen}
                    \KwSend a.end \KwTo a.source\;
                    \KwSend a.packet \KwTo a.source\;
                }
            }

            \tcp{TODO: Perform cleanup of no longer relevant transmissions}
        }
    }
    \caption{The \texttt{Coordinator} procedure.}
    \label{algo:mpicoordinator}
\end{algorithm}

%  \begin{algorithm}[ht]
%      \DontPrintSemicolon
%      \KwResult{True if the transmission should be received.}
%      \SetKwFunction{FShouldReceive}{ShouldReceive}
%      \SetKwProg{Fn}{Function}{}{}
    
%      \Fn{\FShouldReceive{l, t, interferers, packetsize}}{
%         %  n$_r \leftarrow$ l.id\;
%         %  n$_t \leftarrow$ t.id\;
%         %  \ForEach{t$^\prime$ $\in$ transmissions - \{t\}}{
%         %      \If{t.end $>$ t$^\prime$.start \KwAnd t.start $<$ t$^\prime$.end}{
%         %          \KwAppend t$^\prime$ \KwTo nodes$_t$\;
%         %      }
%         %  }

  
%      }

%      \caption{The \texttt{ShouldReceive} Function.}
%      \label{algo:controllershouldreceive}
%  \end{algorithm}