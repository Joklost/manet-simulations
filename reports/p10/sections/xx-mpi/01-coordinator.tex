
\begin{algorithm}[H]
    \DontPrintSemicolon
    \SetKwFunction{FCoordinator}{Coordinator}
    \SetKwProg{Fn}{procedure}{}{}

    \tcp{Tuples are accessed by dot notation}
    Message = (type, source, localtime, duration, data)\;
    Action = (type, source, start, end, packets)\;
    \;

    \Fn{\FCoordinator{}}{
        transmissions $\leftarrow$ empty Transmission list\;
        listens $\leftarrow$ priority queue \tcp{listen actions are ordered by end time}
        nodes $\leftarrow$ map containing localtime of all nodes with id as key\;

        \;
        
        \Repeat{\textit{protocol terminates}}{
            m $\leftarrow$ \Await Message \From any node\; \label{line:action-await}
            nodes(m.source).localtime $\leftarrow$ m.localtime + m.duration \tcp{This takes care of sleep/inform}
            coordinatortime $\leftarrow \min_{\text{n} \in \text{nodes}}$(n.localtime)\; \label{line:controllertime}
            \;

            \If{m.type = transmit}{ \label{line:action-transmit}
                t $\leftarrow$ (transmit, m.source, m.localtime, m.localtime $+$ m.duration, m.data)\;
                \Append t \KwTo transmissions\;
            }

            \ElseIf{m.type = listen}{ \label{line:action-listen}
                l $\leftarrow$ (listen, m.source, m.localtime, m.localtime $+$ m.duration )\;
                \Enqueue l \KwTo listens\;
            }
            \;
            \While{listens is not empty}{
                l $\leftarrow$ \Head listens\;
                \If{l.end > coordinatortime}{
                    \Break\;
                }

                \Dequeue l \From listens\;
                packets $\leftarrow$ empty Packet list\;
            
                \ForEach{t $\in$ transmissions}{
                    \If{\texttt{ShouldReceive}(l, t, transmissions, |t.data|)}{
                        \Append t.data \To packets\;
                    }
                }

                \Send $|$packets$|$ \To l.source\; \label{line:sendcount}
                \ForEach{p $\in$ packets}{ \label{line:sendpackets}
                    \Send p \To l.source\;
                } 
            }
            \;
            \ForEach{t $\in$ transmissions}{
                \If{t.end < coordinatortime}{
                    \Remove t \From transmissions\;
                }
            }
        }
    }
    \caption{The \texttt{Coordinator} procedure.}
    \label{algo:mpicoordinator}
\end{algorithm}

\begin{algorithm}[ht]
    \DontPrintSemicolon
    \KwResult{True if the transmission should be received.}
    \SetKwFunction{FShouldReceive}{ShouldReceive}
    \SetKwProg{Fn}{Function}{}{}
    
    \Fn{\FShouldReceive{l, t, transmissions, packetsize}}{
        n$_r \leftarrow$ l.id\;
        n$_t \leftarrow$ t.id\;
        nodes$_t \leftarrow$ empty Transmission list\;

        \ForEach{t$^\prime$ $\in$ transmissions - \{t\}}{
            \If{t.end $>$ t$^\prime$.start \And t.start $<$ t$^\prime$.end}{
                \Append t$^\prime$ \To nodes$_t$\;
            }
        }

        probability $\leftarrow$ $P_p(\text{n}_r, \text{m}_t, \text{nodes}_t, \text{packetsize})$\;
        should-receive $\leftarrow$ randomly choose based on probability\;
        \KwRet should-receive\;
    }

    \caption{The \texttt{ShouldReceive} Function.}
    \label{algo:controllershouldreceive}
\end{algorithm}