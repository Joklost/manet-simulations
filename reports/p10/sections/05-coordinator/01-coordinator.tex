\clearpage
\section{Coordinator}\label{sec:coordinator}
To facilitate communication between nodes using the hardware interface, we introduce the Coordinator. The Coordinator works by gathering actions ($transmit$, $listen$, $sleep$, and $inform$) sent from nodes using an \gls{mpi}. The pseudo code description of the Coordinator can be seen in \autoref{algo:mpicoordinator}. \smallbreak

The Coordinator works by continuously awaiting actions from any node (\autoref{algo:mpicoordinator:action-await}). The \KwAwait keyword is blocking, and blocks until any node sends an action to the Coordinator. An action is the 5-tuple Action = $(type,\ source,\ start,\ end,\ packet)$. Accessing an element of an action is done with the dot ($.$) operator, using named access. For example, for the $listen$ action $a = (listen, 1, 2, 5, \KwNull)$ we can access the source of the action using the dot operator as such: $a.source = 1$. The $type$ element denotes the type of the action, and is one of either $transmit$, $listen$, $sleep$, or $inform$. The $source$ element is the unique identifier of the source node that submitted the action to the Coordinator. The $start$ and $end$ elements are timestamps for points of time in the execution, where $start \leq end$. Finally, the $packet$ element is the data packet sent during a transmission, or \KwNull for any action where $type \neq transmit$. \smallbreak

The pseudo code of the Coordinator is separated into three parts, where each of the parts is repeatedly executed in sequence, until the protocol terminates. The first part takes care of receiving actions from nodes, the second part maintains and cleans the $transmits$ set of $transmit$ actions, and the third part processes, and removes, actions from the $waiting$ queue. \smallbreak

Whenever an action is submitted to the Coordinator (\autoref{algo:mpicoordinator:action-await}), the action is enqueued in the $waiting$ queue. The $waiting$ queue is a priority queue of Action objects, where the actions are ordered by their end time, with $transmit$ actions before $listen$ actions, in case of a tie. The ordering of $sleep$ and $inform$ in relation to $transmit$ or $listen$ actions are irrelevant. If the received action is a $transmit$ action, the action is also added to the $transmits$ set (\autoref{algo:mpicoordinator:message-transmit}). Note that any action we receive from a particular node during this part will always have a start time greater than or equal to the end time of the last action received from that node. After receiving an action, the Coordinator continues to the second part. \smallbreak

The $transmits$ set is used to gather any $transmit$ actions that may cause interference when processing $transmit$ actions in the third part of the Coordinator. In order to make sure that the size of the $transmits$ set does not grow indefinitely, we remove $transmit$ actions that will not interfere with future $transmit$ actions. To do this we check that the $waiting$ queue contains at least one action from each node (\autoref{algo:mpicoordinator:ifactions}). Next, we find the earliest start time of all actions in the $waiting$ queue. With this we can remove any $transmit$ actions where the end time is strictly less that then earliest start time found in the $waiting$ queue (\autoref{algo:mpicoordinator:cleantransmits}). \smallbreak

Finally, the 

\paragraph{Part 3} \

\begin{itemize}
    \item The $sleep$ and $inform$ actions are handled implicitly as we simply dequeue the actions at \autoref{algo:mpicoordinator:dequeue}. No further processing is needed, as the actions only have to be present on the $waiting$ queue, to satisfy the condition at \autoref{algo:mpicoordinator:whileactions}.
    \item As $transmit$ actions always are processed before $listen$ actions, we can safely remove $listen$ actions from the queue when processing a $transmit$ action, and process the $listen$ action by sending the end time and packet of the $transmit$ action to the source of the $listen$ action, should the packet be received by the node at \autoref{algo:mpicoordinator:shouldreceive}.
    \item If we dequeue a $listen$ action at \autoref{algo:mpicoordinator:dequeue}, we know that no packets were received for the action, and we can send \KwNull to the $source$ of the listen action at \autoref{algo:mpicoordinator:sendnull}.
    \item It is assumed that a $transmit$ action will interfere entirely with another $transmit$ action if the time intervals of the two actions intersect at any point in time (\autoref{algo:mpicoordinator:transmitintersects}), rather than interfering only for the intersecting time.
\end{itemize}

\input{figures/coordinator.tex}

% \subsection{Coordinator notes}
% \todo[inline]{rewrite as text}
% \paragraph{Part 1} \

% \begin{itemize}
%     \item The \KwAwait keyword is blocking, and blocks until a node sends an action.
%     \item Any action we receive from a node at \autoref{algo:mpicoordinator:action-await} will always have a $start$ time greater than or equal to the latest end time of any action from that node.
%     \item Only $transmit$ actions need special handling in Part 1. Any action we received is added to the $waiting$ queue, and at \autoref{algo:mpicoordinator:message-transmit} we add any $transmit$ actions to the $transmits$ set.
%     \item After receiving a single action the Coordinator moves to Part 2, where we process all possible actions while the condition at \autoref{algo:mpicoordinator:whileactions} is satisfied.
% \end{itemize}

% \paragraph{Part 2} \

% \begin{itemize}
%     \item Any $transmit$ action in the $transmits$ set can be removed when it can no longer interfere with other $transmit$ actions. At \autoref{algo:mpicoordinator:cleantransmits} any $transmit$ actions in the $transmits$ set is removed if the end time is before the earliest start time of all actions in the $waiting$ queue.
%     \item The $transmits$ set will be cleaned, only if the condition at \autoref{algo:mpicoordinator:ifactions} is true. As the while loop at \autoref{algo:mpicoordinator:whileactions} has the same condition, the $transmits$ set will be cleaned only before processing the $waiting$ queue.
%           %\item If a $transmit$ action is in the $transmits$ list and is no longer on the $waiting$ queue then the action has already been processed, and can be safely removed.
% \end{itemize}
