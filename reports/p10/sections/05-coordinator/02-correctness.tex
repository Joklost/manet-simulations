\section{Correctness}
\todo[inline]{introduction}

\subsection{Invariants}\label{sec:coordinator-invariants}

With a set of $N$ unique node identifiers where $\mathit{nodes} = \{ 1, 2, 3, \ldots, N \}$, %
the following invariants hold:

\begin{enumerate}
    \item For all $n \in \mathit{nodes}$, there exists at most one $a \in \mathit{waiting}$ such that 
          $a.\mathit{source} = n$ and $a.\mathit{type} = \mathit{listen}$.
          \begin{itemize}
              \item There is at most one action with the $\mathit{listen}$ type from each node in the 
                    $\mathit{waiting}$ queue.
          \end{itemize}
    \item For all $a, b \in \mathit{waiting}$, if $a.\mathit{source} = b.\mathit{source}$ and 
          $a.\mathit{type} = \mathit{listen}$ then $b.\mathit{end} \leq a.\mathit{start}$.
          \begin{itemize}
              \item If a node has a $\mathit{listen}$ action in the waiting queue, no other actions may be 
                    present after this.
          \end{itemize}
    \item For all $a \in \mathit{discovered}$, if $a.\mathit{type} = \mathit{transmit}$ and there exists 
          $b \in \mathit{waiting}$ such that $b.\mathit{type} = \mathit{transmit}$ and 
          $a.\mathit{end} \geq b.\mathit{start}$ and $a.\mathit{start} \leq b.\mathit{end}$ then 
          $a \in \mathit{transmits}$.
          \begin{itemize}
              \item Every \textit{transmit} action submitted to the Coordinator that could possibly 
                    interfere with any \textit{transmit} action on the \textit{waiting} queue must be 
                    present in the \textit{transmits} set.
          \end{itemize}
\end{enumerate}

The first and second invariants are satisfied both by the implementation of the Listen function 
(\autoref{algo:hwfuncslisten} in \autoref{sec:hwfuncspseudo}), and by the Coordinator. The Listen function 
uses the blocking \KwAwait keyword on \autoref{algo:hwfuncslisten:awaitend} in \autoref{algo:hwfuncslisten}, 
to wait for a response from the Coordinator. The Coordinator, in turn, sends a response to the source of the 
$listen$ action only after the action already has been removed from the $waiting$ queue at 
\autoref{algo:mpicoordinator:dequeue} or \autoref{algo:mpicoordinator:removelisten} in 
\autoref{algo:mpicoordinator}. Due to the blocking nature of the \KwAwait keyword, and the fact that a node 
is only able to continue execution after a response have been received from the Coordinator, the invariants 
are satisfied, as it is impossible for a node to send more actions to the Coordinator, while a $listen$ 
action from the same node is already on the $waiting$ queue. 
\smallbreak

The third invariant is satisfied as long as any \textit{transmit} actions that could possibly interfere with 
any \textit{transmit} action in the \textit{waiting} queue is present in the \textit{transmits} set. 

To aid in this
To track this, we utilise the \textit{discovered} set. 

With the \textit{discovered} set we can still track the
\textit{transmit} actions that have been removed from the \textit{waiting} queue, as these could interfere 
with future \textit{transmit} actions. A \textit{transmit} action $a$ interferes with another 
\textit{transmit} action $b$, as long as the time interval for the actions intersect at some point  
($a.\mathit{end} \geq b.\mathit{start}$ and $a.\mathit{start} \leq b.\mathit{end}$). 


At \autoref{algo:mpicoordinator:cleantransmits}
in \autoref{algo:mpicoordinator} we have the condition that we only remove $\mathit{transmit}$ actions from 
the $\mathit{transmits}$ set if the end time of any action in the set is less than the earliest start time of 
all actions in $\mathit{waiting}$. This means that if we have a $\mathit{transmit}$ action both in the 
$\mathit{waiting}$ queue and $\mathit{transmits}$ set, we will not be able to remove it from the 
$\mathit{transmits}$ set, before the action has been removed from the $\mathit{waiting}$ queue, according to 
the condition at \autoref{algo:mpicoordinator:cleantransmits}. If we have an action $t \in \mathit{waiting}$ 
where $t \in \mathit{transmits}$ then the earliest start time of all actions in the $\mathit{waiting}$ queue 
is at least $t.\mathit{start}$, which means that we will not be able to remove $t$ from the \textit{transmits} 
set, as $t.\mathit{end} \nless t.\mathit{start}$, and we know from the implementation of the hardware 
functions that for any action $a$, $a.\mathit{start} \leq a.\mathit{end}$, 
as shown in \autoref{sec:hwfuncspseudo}.

%The third invariant is satisfied as long as a $transmit$ action in the $transmits$ set is not removed, 
%before the action has been removed from the $waiting$ queue. 
\subsection{Methodology}\label{sec:correctnessmethods}
Suppose that at a point in time $t$ in an asynchronous real-time execution a listen actions ends, and receives 
a packet with some probability computed, using the packet error probability function $P_p$. With the 
invariants outlined above, we want to prove that the packet would be received with the same probability in a 
virtual-time execution. Due to the asynchronous nature of a wireless communication protocol it is not as 
simple as presenting a single slice of the execution. Instead, to illustrate snapshots of a given point in 
the execution of the Coordinator we introduce the concept of a cut: A cut consist of two horizontal lines, 
\ProcessedLine\ and \SubmittedLine. Everything above the first (\ProcessedLine) has already been processed by 
the Coordinator, and everything below the second (\SubmittedLine) has not yet been submitted to the 
Coordinator. We use a cut to show the content of the data structures within the Coordinator, where we see the 
order of currently queued actions in the $waiting$ queue, as well as the actions in the $transmits$ set. 
\medbreak

Throughout this section we present a sample execution of an arbitrary asynchronous communications protocol with five nodes. The execution is represented as a variant of a message sequence chart where, rather than the nodes communicating with each other (there is no interaction between the nodes), it is assumed that all nodes interact with the Coordinator implicitly. We utilise cuts to present five different possible scenarios of the Coordinator: No action can be processed, processing a $transmit$, processing an $inform$ action, processing a $listen$ action, and finally, processing a $sleep$ action. For each of the different scenarios we start with a concrete example, based on the figure, accompanying the cut, and we end with a generalisation of the scenario.

% we can extract some sense of the states of the nodes from the data structures

\subsection{Sample executions}\label{sec:coordinator-examples}

\autoref{tikz:coordinatormsc0} shows the original message sequence chart we use in the following sections to present different scenarios for the Coordinator. All of the scenarios we present are based on \autoref{tikz:coordinatormsc0}, but with cuts at different points in execution. In the figures, almost all of the actions are represented as a rectangle where the rectangle visually represents the time interval of the action (start, end), and the center of the rectangle is the identifier of the action (e.g., \T{1}{5}). For example, the action \T{1}{5} is the 5-tuple $\T{1}{5} = (transmit, 1, 2, 5, data)$, in \autoref{sec:coordinator}, where $data \neq$ \KwNull if type = $transmit$. Note that the only action not represented by a rectangle is the $inform$ action, as this action has the same start and end time. This action is represented by a short line, where the identifier of the action is placed above the line. The figure presents the execution of an arbitrary wireless communication protocol where each of the five nodes has their own timeline of actions submitted throughout the execution of the protocol on the vertical dashed line originating from each of the nodes. \medbreak

The following is the result of processing each of the $transmit$ actions from \autoref{tikz:coordinatormsc0}, and serve as the timeline of the Coordinator processing the $transmit$ actions throughout the execution: %
%
\begin{description}[leftmargin=2em,style=nextline]
    \item[\T{4}{3}] The packet originating from \Node{4} (\T{4}{3}) was dropped by \Node{3} (\L{3}{6}) to interference from \Node{1} (\T{1}{5}). \Node{2} (\L{2}{5}) started listening too soon to receive the packet.
    \item[\T{1}{5}] The packet originating from \Node{1} (\T{1}{5}) was received by \Node{2} (\L{2}{5}) at time 5, but dropped by \Node{3} (\L{3}{6}) to interference from \Node{4} (\T{4}{3}).
    \item[\T{1}{10}] The transmission from \Node{1} (\T{1}{10}) was not received by any listening nodes, as \Node{5} (\L{5}{9}) stopped listening too soon, while \Node{3} (\L{3}{10}) started listening too late.
    \item[\T{2}{10}] The packet originating from \Node{2} (\T{2}{10}) was dropped by \Node{3} (\L{3}{10}) to interference from \Node{1}.
    \item[\T{5}{12}] The packet originating from \Node{5} (\T{5}{12}) was received by \Node{4} (\L{4}{14}) at time 12, but dropped by \Node{2} (\L{2}{14}) due to distance.
    \item[\T{3}{16}] The packet originating from \Node{3} (\T{3}{16}) was dropped by \Node{1} (\L{1}{18}) to interference from \Node{4} (\T{4}{17}).
    \item[\T{4}{17}] The packet originating from \Node{4} (\T{4}{17}) was dropped by \Node{1} (\L{1}{18}) to interference from \Node{2} (\T{2}{18}), \Node{3} (\T{3}{16}), and \Node{5} (\T{5}{18}).
    \item[\T{2}{18}] The packet originating from \Node{2} (\T{2}{18}) was dropped by \Node{1} (\L{1}{18}) to interference from \Node{4} (\T{4}{17}), and \Node{5} (\T{5}{18}).
    \item[\T{5}{18}] The packet originating from \Node{5} (\T{5}{18}) was dropped by \Node{1} (\L{1}{18}) to interference from \Node{2} (\T{2}{18}), and \Node{4} (\T{4}{17}).
    \item[\T{3}{20}] The packet originating from \Node{3} (\T{3}{20}) was received by \Node{4} (\L{4}{20}).
\end{description}

\begin{figure}[H]
    \centering
    % Diagram
    \CoordinatorFigure{}
    \caption{Sample execution of an arbitrary protocol with five nodes.}\label{tikz:coordinatormsc0}
\end{figure}

\subsubsection{Cut 1: Nothing can be processed}
For the first cut we have a scenario where nothing may be processed. Recall that the condition for Part 3 of the Coordinator procedure is that the waiting queue is only processed if all nodes have at least one action on the queue. As of this cut, \Node{3} has yet to submit an action to the Coordinator, which means that the Coordinator is unable to progress from this point until the \L{3}{6} action is submitted at some point, later in the execution. Note that due to the asynchronous nature of a \gls{manet}, and the fact that only $listen$ actions are blocking on the hardware side, it is very possible to have a scenario, where a node has submitted a large number of actions, as \Node{1} has in the figure, where \Node{1} is currently waiting for the \L{1}{18} action to be processed, and \Node{3} has yet to submit any actions to the Coordinator. Additionally, nodes may be doing other work internally, before submitting more actions to the Coordinator, which is why \Node{4} might not have submitted the $listen$ action \L{4}{14} as of this cut. \Node{1}, \Node{2}, and \Node{5} are not able to submit more actions to the Coordinator, before the $listen$ actions they have submitted have been processed.

\begin{figure}[H]
    \centering
    % Diagram
    \CoordinatorFigure{%
        \LineLegend
        \Processed{%
            (sep0-2.center) -- (sep2-2.center) -- %
            (sep2-1.center) -- (sep3-1.center) -- %
            (sep4-1.center) -- (sep4-3.center) -- %
            (sep5-3.center) %
        }

        \Submitted{%
            (sep0-18.center) -- (sep1-18.center) -- %
            (sep1-5.center) -- (sep2-5.center) -- %
            (sep2-1.center) -- (sep3-1.center) -- %
            (sep3-8.center) -- (sep4-8.center) -- %
            (sep4-9.center) -- (sep5-9.center) -- %
            (sep5-9.center) %
        }
    }
    \caption{Cut 1}\label{tikz:coordinatormsc1}
\end{figure}

The content of the waiting queue and transmits list at the time of this cut is: \smallbreak

$waiting \leftarrow \Big\langle%
    \T{4}{3}, %
    \I{5}{3}, %
    \T{1}{5}, %
    \L{2}{5}, %
    %\L{3}{6}, %
    \S{5}{6}, %
    %\S{2}{7}, %
    \S{4}{8}, %
    \L{5}{9}, %
    \T{1}{10}, %
    \I{1}{12}, %
    \S{1}{14}, %
    \L{1}{18} %
    \Big\rangle$

$transmits \leftarrow \Big\{ \T{4}{3}, \T{1}{5}, \T{1}{10} \Big\}$ \smallbreak

The $waiting$ queue is a priority queue where actions are ordered by end time, and $transmit$ actions must be before $listen$ actions, if the end time is the same.

\subsubsection{Cut 2: $transmit$ action}
The next cut is a snapshot of the Coordinator directly after \Node{3} has submitted the \L{3}{6} action. With this action in the $waiting$ queue, the Coordinator may begin to process the actions in the $waiting$ queue and $transmits$ set. First the Coordinator would check if any $transmit$ actions should be removed from the $transmits$ set, but as none of the actions in the set has a start time earlier than the start time of the earliest action in the $waiting$ queue (\L{3}{6} or \T{4}{3}, both with start = 1) nothing can be removed. Next, the Coordinator can begin processing actions in the $waiting$ queue. %\smallbreak

\begin{figure}[H]
    \centering
    % Diagram
    \CoordinatorFigure{%
        \LineLegend
        \Processed{%
            (sep0-2.center) -- (sep2-2.center) -- %
            (sep2-1.center) -- (sep3-1.center) -- %
            (sep4-1.center) -- (sep4-3.center) -- %
            (sep5-3.center) %
        }

        \Submitted{%
            (sep0-18.center) -- (sep1-18.center) -- %
            (sep1-5.center) -- (sep2-5.center) -- %
            (sep2-6.center) -- (sep3-6.center) -- %
            (sep3-8.center) -- (sep4-8.center) -- %
            (sep4-9.center) -- (sep5-9.center) -- %
            (sep5-9.center) %
        }
    }

    \caption{Cut 2}\label{tikz:coordinatormsc2}
\end{figure}

\todo[inline]{refer back to RSSI and interference section in the following}

The first action in the $waiting$ queue is the $transmit$ action \T{4}{3}. Recall that when processing a $transmit$ action, the Coordinator iterates through the $transmits$ set to find other $transmit$ actions with intersecting time intervals. In this case, only the \T{1}{5} action intersects with the \T{4}{3} action, so the source of that action is included in the $interferers$ set. Next, the Coordinator iterates through all $listen$ actions in the $waiting$ queue, and only if the time interval for the $transmit$ action is wholly within the time interval of any $listen$ action, we compute the probability for packet error on a transmission between the source of the $listen$ action ($\L{3}{6}.source$) and the source of the $transmit$ action ($\T{4}{3}.source$). With the probability for packet error, \autoref{eq:pep} in \autoref{sec:radiomodel}, $probability = P_p(\L{3}{6}.source, \T{4}{3}.source, \{ \T{1}{5}.source \}, |\T{4}{3}.packet|, \T{4}{3}.end)$, we can randomly choose whether the transmission should be received, or dropped, and either finish processing the $listen$ action by sending the packet to the source of the action, or move on to the next $listen$ action. For the \T{4}{3} action, we assume the packet to be dropped by the listening node. \medbreak

When processing the \T{4}{3} action we have two cases to consider for this particular scenario: In the first case, the packet is received by \Node{3} and the \L{3}{6} action is removed from the $waiting$ queue. Should this be the case, the condition for processing actions in the $waiting$ queue is no longer satisfied, and the Coordinator will not be able to process any further actions until the \L{3}{10} action has been submitted to the Coordinator. In the second case, the packet is dropped and not received by \Node{3}. In this case, the \L{3}{6} action is still on the $waiting$ queue, and the Coordinator can continue processing actions as the $waiting$ queue still contains at least one action from each node. \medbreak

This holds in general, as every $listen$ action will be after any $transmit$ action $t$ on the $waiting$ queue, and every $transmit$ action that could possibly interfere with $t$ is in the $transmits$ set. \medbreak

The content of the waiting queue and transmits list at the time of this cut is: \smallbreak

$waiting \leftarrow \Big\langle%
    \T{4}{3}, %
    \I{5}{3}, %
    \T{1}{5}, %
    \L{2}{5}, %
    \S{5}{6}, %
    \L{3}{6}, %
    \S{4}{8}, %
    \L{5}{9}, %
    \T{1}{10}, %
    \I{1}{12}, %
    \S{1}{14}, %
    \L{1}{18} %
    \Big\rangle$

$transmits \leftarrow \Big\{ \T{4}{3}, \T{1}{6}, \T{1}{10} \Big\}$

\subsubsection{Cut 3: $inform$ action}
The next cut is a snapshot of the Coordinator directly after the \T{4}{3} action has been processed and removed from the $waiting$ queue. The condition for processing actions remains satisfied, as there is still at least action from each node in the $waiting$ queue. At the head of the $waiting$ queue is the $inform$ action \I{5}{3}. Processing an $inform$ action is trivial, as no processing is needed for this action. The action is simply removed from the $waiting$ queue, and the Coordinator may move on to the next action, if the condition is still satisfied. This holds in general for any $inform$ action. \smallbreak

Note that the only change in the $waiting$ queue, from the previous cut, is the removal of the \T{4}{3} action, which still remains in the $transmits$ set, as the end time of the \T{4}{3} action is still greater than, or equal to, the start time of the \L{3}{6} action, and causes interference for the \T{1}{5} action (the next action in the queue). Additionally, no new actions have been submitted between the 2nd and 3rd cuts, as a new action is received only if the condition for processing actions is no longer satisfied. \medbreak

$waiting \leftarrow \Big\langle%
    %\T{4}{3}, %
    \I{5}{3}, %
    \T{1}{5}, %
    \L{2}{5}, %
    \S{5}{6}, %
    \L{3}{6}, %
    \S{4}{8}, %
    \L{5}{9}, %
    \T{1}{10}, % 
    \I{1}{12}, %
    \S{1}{14}, %
    \L{1}{18} %
    \Big\rangle$

$transmits \leftarrow \Big\{ \T{4}{3}, \T{1}{6}, \T{1}{10} \Big\}$

\begin{figure}[H]
    \centering
    % Diagram
    \CoordinatorFigure{%
        \LineLegend
        \Processed{%
            (sep0-2.center) -- (sep2-2.center) -- %
            (sep2-1.center) -- (sep3-1.center) -- %
            (sep3-3.center) -- (sep4-3.center) -- %
            (sep5-3.center) %
        }

        \Submitted{%
            (sep0-18.center) -- (sep1-18.center) -- %
            (sep1-5.center) -- (sep2-5.center) -- %
            (sep2-6.center) -- (sep3-6.center) -- %
            (sep3-8.center) -- (sep4-8.center) -- %
            (sep4-9.center) -- (sep5-9.center) -- %
            (sep5-9.center) %
        }
    }

    \caption{Cut 3}\label{tikz:coordinatormsc3}
\end{figure}


\subsubsection{Cut 4: $listen$ action}
This cut shows a snapshot of the Coordinator directly after the \T{3}{16} action has been submitted. With this action on the $waiting$ queue the condition for processing actions has been satisfied, and the Coordinator may process the first action on the queue, the \L{2}{14} action. For this cut, there is two interesting points to note. First, when a $listen$ action is at the head of the $waiting$ queue, it means that no packet has been received during this transmission. When this is the case, the action is removed, and \KwNull is sent to the source of the $listen$ action. Second, the \L{4}{14} action has already been processed, and removed from the $waiting$ queue, even though the action could not have been processed before the \T{3}{16} action had been submitted. The $listen$ action has removed from the $waiting$ queue early, as the node had received a packet when processing the \T{5}{12} action.  \medbreak

This holds in general, as no $transmit$ action can be wholly within the time interval of any $listen$ action, if the $listen$ action is at the head of the $waiting$ queue. The $listen$ action would have been removed when processing earlier $transmit$ actions, as $transmit$ actions are ordered before $listen$ actions in the $waiting$ queue. \medbreak

%Additionally, the \T{1}{10} and \T{2}{10} actions in the $transmits$ list are not removed, as the end time of the actions is not strictly less than the start time

The content of the $waiting$ queue and $transmits$ set at the time of this cut is: \smallbreak

$waiting \leftarrow \Big\langle%
    %\T{4}{3}, %
    %\I{5}{3}, %
    %\T{1}{5}, %
    %\L{2}{5}, %
    %\S{5}{6}, %
    %\L{3}{6}, %
    %\S{2}{7}, %
    %\S{4}{8}, %
    %\L{5}{9}, %
    %\T{1}{10}, %
    %\T{2}{10}, %
    %\L{3}{10}, %
    %\I{1}{12}, %
    %\T{5}{12}, %
    %\I{3}{13}, %
    \L{2}{14}, %
    \S{1}{14}, %
    %\L{4}{14}, % \T{5}{12} popped this
    \T{3}{16}, % just added
    \T{4}{17}, %
    \T{5}{18}, %
    \L{1}{18}, %
    \L{4}{20} %
    \Big\rangle$

$transmits \leftarrow \Big\{ \T{1}{10}, \T{2}{10}, \T{5}{12}, \T{3}{16}, \T{4}{17}, \T{5}{18} \Big\}$ \smallbreak


\begin{figure}[H]
    \centering
    % Diagram
    \CoordinatorFigure{%
        \LineLegend
        \Processed{%
            (sep0-13.center) -- (sep1-13.center) -- %
            (sep1-10.center) -- (sep2-10.center) -- %
            (sep2-14.center) -- (sep3-14.center) -- %
            (sep3-15.center) -- (sep4-15.center) -- %
            (sep4-16.center) -- (sep5-16.center)
        }

        \Submitted{%
            (sep0-18.center) -- (sep1-18.center) -- %
            (sep1-14.center) -- (sep2-14.center) -- %
            (sep2-16.center) -- (sep3-16.center) -- %
            (sep3-20.center) -- (sep4-20.center) -- %
            (sep4-18.center) -- (sep5-18.center) %
        }
    }

    \caption{Cut 4}\label{tikz:coordinatormsc4}
\end{figure}

\subsubsection{Cut 5: $sleep$ action}
The final cut is a snapshot of the Coordinator directly after the \T{2}{18} action has been submitted to the Coordinator. The \T{2}{18} action was submitted by \Node{2} after the \L{2}{14} action had been processed without the node receiving any data, and the $transmit$ action enabled the Coordinator to continue processing actions from the $waiting$ queue. The head of the $waiting$ queue is the $sleep$ action \S{1}{14}, which, similarly to an $inform$ action, is trivial to process, as no processing is needed for the Coordinator. Again, similarly to an $inform$ action, this holds in general for any $sleep$ action. \smallbreak

After removing the \L{2}{14} action from the $waiting$ queue, the Coordinator were able to remove the \T{1}{10}, \T{2}{10}, and \T{5}{12} actions from the $transmits$ set, as the new earliest start time is now the start time of the \S{1}{14} action. \medbreak

$waiting \leftarrow \Big\langle%
    %\T{4}{3}, %
    %\I{5}{3}, %
    %\T{1}{5}, %
    %\L{2}{5}, %
    %\S{5}{6}, %
    %\L{3}{6}, %
    %\S{2}{7}, %
    %\S{4}{8}, %
    %\L{5}{9}, %
    %\T{1}{10}, %
    %\T{2}{10}, %
    %\L{3}{10}, %
    %\I{1}{12}, %
    %\T{5}{12}, %
    %\I{3}{13}, %
    %\L{2}{14}, %
    \S{1}{14}, %
    %\L{4}{14}, % \T{5}{12} popped this
    \T{3}{16}, % 
    \T{4}{17}, %
    \T{5}{18}, %
    \T{2}{18}, % just added
    \L{1}{18}, %
    \L{4}{20}, %
    %\I{2}{20} % NOT added
    \Big\rangle$

% \T{1}{10}, \T{2}{10}, \T{5}{12}, (removed)

$transmits \leftarrow \Big\{ \T{3}{16}, \T{4}{17}, \T{2}{18}, \T{5}{18} \Big\}$ \smallbreak


\begin{figure}[H]
    \centering
    % Diagram
    \CoordinatorFigure{%
        \LineLegend
        \Processed{%
            (sep0-13.center) -- (sep1-13.center) -- %
            (sep1-14.center) -- (sep2-14.center) -- %
            (sep2-14.center) -- (sep3-14.center) -- %
            (sep3-15.center) -- (sep4-15.center) -- %
            (sep4-16.center) -- (sep5-16.center)
        }

        \Submitted{%
            (sep0-18.center) -- (sep1-18.center) -- %
            (sep1-18.center) -- (sep2-18.center) -- %
            (sep2-16.center) -- (sep3-16.center) -- %
            (sep3-20.center) -- (sep4-20.center) -- %
            (sep4-18.center) -- (sep5-18.center) %
        }
    }

    \caption{Cut 5}\label{tikz:coordinatormsc5}
\end{figure}

\subsection{Proof}\label{sec:proof}
\todo[inline]{todo: finish}